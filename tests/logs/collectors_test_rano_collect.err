+ set -euo pipefail
++ dirname /data/projects/vibe_cockpit/tests/e2e/collectors/test_rano_collect.sh
+ source /data/projects/vibe_cockpit/tests/e2e/collectors/../lib/test_helpers.sh
++ set -euo pipefail
++++ dirname /data/projects/vibe_cockpit/tests/e2e/collectors/../lib/test_helpers.sh
+++ cd /data/projects/vibe_cockpit/tests/e2e/collectors/../lib
+++ pwd
++ TEST_LIB_DIR=/data/projects/vibe_cockpit/tests/e2e/lib
+++ dirname /data/projects/vibe_cockpit/tests/e2e/lib
++ E2E_DIR=/data/projects/vibe_cockpit/tests/e2e
+++ cd /data/projects/vibe_cockpit/tests/e2e/../..
+++ pwd
++ PROJECT_ROOT=/data/projects/vibe_cockpit
+++ find_vc_binary
+++ [[ -n /data/tmp/cargo-target ]]
+++ [[ -x /data/tmp/cargo-target/debug/vc ]]
+++ echo /data/tmp/cargo-target/debug/vc
+++ return
++ VC_BIN=/data/tmp/cargo-target/debug/vc
+++ basename /data/projects/vibe_cockpit/tests/e2e/collectors/test_rano_collect.sh .sh
++ TEST_NAME=test_rano_collect
++ TEST_ASSERTIONS=0
++ TEST_FAILURES=0
+++ date +%s%N
++ TEST_START_TIME=1769623486755916882
++ VC_LAST_OUTPUT=
++ RED='\033[0;31m'
++ GREEN='\033[0;32m'
++ YELLOW='\033[1;33m'
++ NC='\033[0m'
++ trap cleanup_test_env EXIT
+ test_info 'Starting rano collector E2E test'
+ test_log INFO 'Starting rano collector E2E test'
+ local level=INFO
+ shift
++ date -Iseconds
+ echo '[2026-01-28T13:04:46-05:00] [INFO] Starting rano collector E2E test'
[2026-01-28T13:04:46-05:00] [INFO] Starting rano collector E2E test
+ setup_test_env
+ test_info 'Setting up test environment'
+ test_log INFO 'Setting up test environment'
+ local level=INFO
+ shift
++ date -Iseconds
+ echo '[2026-01-28T13:04:46-05:00] [INFO] Setting up test environment'
[2026-01-28T13:04:46-05:00] [INFO] Setting up test environment
++ mktemp -d -t vc_e2e_test_rano_collect_XXXXXX
+ TEST_TEMP_DIR=/data/tmp/vc_e2e_test_rano_collect_4oNrxb
+ export TEST_TEMP_DIR
+ TEST_DB_PATH=/data/tmp/vc_e2e_test_rano_collect_4oNrxb/test.duckdb
+ export TEST_DB_PATH
+ TEST_CONFIG_PATH=/data/tmp/vc_e2e_test_rano_collect_4oNrxb/config.toml
+ cat
+ export TEST_CONFIG_PATH
+ test_info 'Test temp dir: /data/tmp/vc_e2e_test_rano_collect_4oNrxb'
+ test_log INFO 'Test temp dir: /data/tmp/vc_e2e_test_rano_collect_4oNrxb'
+ local level=INFO
+ shift
++ date -Iseconds
+ echo '[2026-01-28T13:04:47-05:00] [INFO] Test temp dir: /data/tmp/vc_e2e_test_rano_collect_4oNrxb'
[2026-01-28T13:04:47-05:00] [INFO] Test temp dir: /data/tmp/vc_e2e_test_rano_collect_4oNrxb
+ RANO_BIN_DIR=/data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin
+ mkdir -p /data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin
+ cat
+ chmod +x /data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin/rano
+ export PATH=/data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin:/home/ubuntu/.codex/tmp/path/codex-arg0eJszyB:/home/ubuntu/.bun/install/global/node_modules/@openai/codex/vendor/x86_64-unknown-linux-musl/path:/data/tmp/.tmpMpmAMF:/data/tmp/.tmpzam3q7:/data/tmp/.tmpoyAfve:/data/tmp/.tmpe6g78I:/data/tmp/.tmpPd69rK:/data/tmp/.tmpGRbjsw:/data/tmp/.tmpz2brVn:/data/tmp/.tmp0PnFJv:/data/tmp/.tmpPoRhAM:/data/tmp/.tmpFfkQ40:/data/tmp/.tmpuxSIpy:/data/tmp/.tmpXjJuNc:/data/tmp/.tmpTZnvXD:/data/tmp/.tmpuK4iIg:/data/tmp/.tmpajeyt7:/data/tmp/.tmpev6kRK:/data/tmp/.tmpiDVpJA:/data/tmp/.tmpnDRhga:/data/tmp/.tmpzxxM5v:/data/tmp/.tmpvKVXKw:/data/tmp/.tmpmNPIdP:/data/tmp/.tmpVFL4Sw:/data/tmp/.tmp7ItVFC:/data/tmp/.tmp0vGjRa:/data/tmp/.tmpBllZzw:/data/tmp/.tmpobicww:/data/tmp/.tmp8f8C2e:/data/tmp/.tmpbD8QBY:/data/tmp/.tmpjzHvSF:/data/tmp/.tmpkjqRCG:/data/tmp/.tmpVzu1zg:/data/tmp/.tmpHO13GV:/data/tmp/.tmprTmBIb:/data/tmp/.tmpRHFAS9:/data/tmp/.tmp84NBm7:/data/tmp/.tmpOXe4sc:/data/tmp/.tmpcOX7LV:/data/tmp/.tmpHmVm2g:/data/tmp/.tmp9gcOZP:/data/tmp/.tmpz4q0R1:/data/tmp/.tmpvkDZiX:/data/tmp/.tmp7Mj5dU:/data/tmp/.tmpdkiSGU:/data/tmp/.tmpDhz6SG:/data/tmp/.tmpxZwXIA:/data/tmp/.tmptoaKcg:/data/tmp/.tmp5WocB2:/data/tmp/.tmpQIUXw6:/data/tmp/.tmp3pRXXR:/data/tmp/.tmpGRxfSM:/data/tmp/.tmpLA8PkL:/data/tmp/.tmpFbmIJR:/data/tmp/.tmpWfLZ76:/data/tmp/.tmpWsTSmr:/data/tmp/.tmpxh3SQx:/data/tmp/.tmp0QcB2I:/data/tmp/.tmpxNatIO:/data/tmp/.tmpupEMqh:/data/tmp/.tmppCYdSE:/data/tmp/.tmpymdjNV:/data/tmp/.tmpCFNqVV:/data/tmp/.tmpdJ2vDZ:/data/tmp/.tmpSewNuz:/data/tmp/.tmpQlKd6y:/data/tmp/.tmprUxpI2:/run/user/1000/fnm_multishells/1141914_1769574439286/bin:/home/ubuntu/.local/share/fnm:/home/ubuntu/google-cloud-sdk/bin:/home/ubuntu/bin:/run/user/1000/fnm_multishells/1141838_1769574439149/bin:/home/ubuntu/.local/share/fnm:/home/ubuntu/google-cloud-sdk/bin:/home/ubuntu/.nvm/versions/node/v24.12.0/bin:/home/ubuntu/.local/bin:/home/ubuntu/.atuin/bin:/home/ubuntu/.bun/bin:/home/ubuntu/go/bin:/home/ubuntu/.cargo/bin:/home/ubuntu/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/snap/bin:/snap/bin
+ PATH=/data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin:/home/ubuntu/.codex/tmp/path/codex-arg0eJszyB:/home/ubuntu/.bun/install/global/node_modules/@openai/codex/vendor/x86_64-unknown-linux-musl/path:/data/tmp/.tmpMpmAMF:/data/tmp/.tmpzam3q7:/data/tmp/.tmpoyAfve:/data/tmp/.tmpe6g78I:/data/tmp/.tmpPd69rK:/data/tmp/.tmpGRbjsw:/data/tmp/.tmpz2brVn:/data/tmp/.tmp0PnFJv:/data/tmp/.tmpPoRhAM:/data/tmp/.tmpFfkQ40:/data/tmp/.tmpuxSIpy:/data/tmp/.tmpXjJuNc:/data/tmp/.tmpTZnvXD:/data/tmp/.tmpuK4iIg:/data/tmp/.tmpajeyt7:/data/tmp/.tmpev6kRK:/data/tmp/.tmpiDVpJA:/data/tmp/.tmpnDRhga:/data/tmp/.tmpzxxM5v:/data/tmp/.tmpvKVXKw:/data/tmp/.tmpmNPIdP:/data/tmp/.tmpVFL4Sw:/data/tmp/.tmp7ItVFC:/data/tmp/.tmp0vGjRa:/data/tmp/.tmpBllZzw:/data/tmp/.tmpobicww:/data/tmp/.tmp8f8C2e:/data/tmp/.tmpbD8QBY:/data/tmp/.tmpjzHvSF:/data/tmp/.tmpkjqRCG:/data/tmp/.tmpVzu1zg:/data/tmp/.tmpHO13GV:/data/tmp/.tmprTmBIb:/data/tmp/.tmpRHFAS9:/data/tmp/.tmp84NBm7:/data/tmp/.tmpOXe4sc:/data/tmp/.tmpcOX7LV:/data/tmp/.tmpHmVm2g:/data/tmp/.tmp9gcOZP:/data/tmp/.tmpz4q0R1:/data/tmp/.tmpvkDZiX:/data/tmp/.tmp7Mj5dU:/data/tmp/.tmpdkiSGU:/data/tmp/.tmpDhz6SG:/data/tmp/.tmpxZwXIA:/data/tmp/.tmptoaKcg:/data/tmp/.tmp5WocB2:/data/tmp/.tmpQIUXw6:/data/tmp/.tmp3pRXXR:/data/tmp/.tmpGRxfSM:/data/tmp/.tmpLA8PkL:/data/tmp/.tmpFbmIJR:/data/tmp/.tmpWfLZ76:/data/tmp/.tmpWsTSmr:/data/tmp/.tmpxh3SQx:/data/tmp/.tmp0QcB2I:/data/tmp/.tmpxNatIO:/data/tmp/.tmpupEMqh:/data/tmp/.tmppCYdSE:/data/tmp/.tmpymdjNV:/data/tmp/.tmpCFNqVV:/data/tmp/.tmpdJ2vDZ:/data/tmp/.tmpSewNuz:/data/tmp/.tmpQlKd6y:/data/tmp/.tmprUxpI2:/run/user/1000/fnm_multishells/1141914_1769574439286/bin:/home/ubuntu/.local/share/fnm:/home/ubuntu/google-cloud-sdk/bin:/home/ubuntu/bin:/run/user/1000/fnm_multishells/1141838_1769574439149/bin:/home/ubuntu/.local/share/fnm:/home/ubuntu/google-cloud-sdk/bin:/home/ubuntu/.nvm/versions/node/v24.12.0/bin:/home/ubuntu/.local/bin:/home/ubuntu/.atuin/bin:/home/ubuntu/.bun/bin:/home/ubuntu/go/bin:/home/ubuntu/.cargo/bin:/home/ubuntu/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/snap/bin:/snap/bin
++ command -v rano
+ rano_path=/data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin/rano
+ assert_ne '' /data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin/rano 'rano binary should be in PATH'
+ local unexpected=
+ local actual=/data/tmp/vc_e2e_test_rano_collect_4oNrxb/bin/rano
+ local 'msg=rano binary should be in PATH'
+ TEST_ASSERTIONS=1
+ [[ '' != \/\d\a\t\a\/\t\m\p\/\v\c\_\e\2\e\_\t\e\s\t\_\r\a\n\o\_\c\o\l\l\e\c\t\_\4\o\N\r\x\b\/\b\i\n\/\r\a\n\o ]]
+ test_info 'PASS: rano binary should be in PATH'
+ test_log INFO 'PASS: rano binary should be in PATH'
+ local level=INFO
+ shift
++ date -Iseconds
+ echo '[2026-01-28T13:04:47-05:00] [INFO] PASS: rano binary should be in PATH'
[2026-01-28T13:04:47-05:00] [INFO] PASS: rano binary should be in PATH
++ rano export --format jsonl --since 10m
+ rano_output='{"ts":"2026-01-28T00:00:00Z","id":1,"provider":"openai","process":"vc","pid":1234,"direction":"outbound","protocol":"https","remote_host":"api.openai.com","remote_ip":"1.2.3.4","remote_port":443,"local_port":54321,"bytes_sent":2048,"bytes_received":4096,"is_known":true,"tags":["api"],"event_type":"connection"}
{"ts":"2026-01-28T00:01:00Z","id":2,"provider":"github","process":"git","pid":2222,"direction":"outbound","protocol":"https","remote_host":"github.com","remote_ip":"5.6.7.8","remote_port":443,"local_port":54322,"bytes_sent":1024,"bytes_received":2048,"is_known":true,"tags":["git"],"event_type":"dns"}'
++ printf '%s\n' '{"ts":"2026-01-28T00:00:00Z","id":1,"provider":"openai","process":"vc","pid":1234,"direction":"outbound","protocol":"https","remote_host":"api.openai.com","remote_ip":"1.2.3.4","remote_port":443,"local_port":54321,"bytes_sent":2048,"bytes_received":4096,"is_known":true,"tags":["api"],"event_type":"connection"}
{"ts":"2026-01-28T00:01:00Z","id":2,"provider":"github","process":"git","pid":2222,"direction":"outbound","protocol":"https","remote_host":"github.com","remote_ip":"5.6.7.8","remote_port":443,"local_port":54322,"bytes_sent":1024,"bytes_received":2048,"is_known":true,"tags":["git"],"event_type":"dns"}'
++ wc -l
++ tr -d ' '
+ line_count=2
+ assert_eq 2 2 'rano JSONL should have 2 lines'
+ local expected=2
+ local actual=2
+ local 'msg=rano JSONL should have 2 lines'
+ TEST_ASSERTIONS=2
+ [[ 2 == \2 ]]
+ test_info 'PASS: rano JSONL should have 2 lines'
+ test_log INFO 'PASS: rano JSONL should have 2 lines'
+ local level=INFO
+ shift
++ date -Iseconds
+ echo '[2026-01-28T13:04:48-05:00] [INFO] PASS: rano JSONL should have 2 lines'
[2026-01-28T13:04:48-05:00] [INFO] PASS: rano JSONL should have 2 lines
+ IFS=
+ read -r line
+ '[' -n '{"ts":"2026-01-28T00:00:00Z","id":1,"provider":"openai","process":"vc","pid":1234,"direction":"outbound","protocol":"https","remote_host":"api.openai.com","remote_ip":"1.2.3.4","remote_port":443,"local_port":54321,"bytes_sent":2048,"bytes_received":4096,"is_known":true,"tags":["api"],"event_type":"connection"}' ']'
+ assert_json_valid '{"ts":"2026-01-28T00:00:00Z","id":1,"provider":"openai","process":"vc","pid":1234,"direction":"outbound","protocol":"https","remote_host":"api.openai.com","remote_ip":"1.2.3.4","remote_port":443,"local_port":54321,"bytes_sent":2048,"bytes_received":4096,"is_known":true,"tags":["api"],"event_type":"connection"}' 'rano JSONL line should be valid JSON'
+ local 'json={"ts":"2026-01-28T00:00:00Z","id":1,"provider":"openai","process":"vc","pid":1234,"direction":"outbound","protocol":"https","remote_host":"api.openai.com","remote_ip":"1.2.3.4","remote_port":443,"local_port":54321,"bytes_sent":2048,"bytes_received":4096,"is_known":true,"tags":["api"],"event_type":"connection"}'
+ local 'msg=rano JSONL line should be valid JSON'
+ TEST_ASSERTIONS=3
+ echo '{"ts":"2026-01-28T00:00:00Z","id":1,"provider":"openai","process":"vc","pid":1234,"direction":"outbound","protocol":"https","remote_host":"api.openai.com","remote_ip":"1.2.3.4","remote_port":443,"local_port":54321,"bytes_sent":2048,"bytes_received":4096,"is_known":true,"tags":["api"],"event_type":"connection"}'
+ jq .
+ test_info 'PASS: rano JSONL line should be valid JSON'
+ test_log INFO 'PASS: rano JSONL line should be valid JSON'
+ local level=INFO
+ shift
++ date -Iseconds
+ echo '[2026-01-28T13:04:48-05:00] [INFO] PASS: rano JSONL line should be valid JSON'
[2026-01-28T13:04:48-05:00] [INFO] PASS: rano JSONL line should be valid JSON
+ IFS=
+ read -r line
+ '[' -n '{"ts":"2026-01-28T00:01:00Z","id":2,"provider":"github","process":"git","pid":2222,"direction":"outbound","protocol":"https","remote_host":"github.com","remote_ip":"5.6.7.8","remote_port":443,"local_port":54322,"bytes_sent":1024,"bytes_received":2048,"is_known":true,"tags":["git"],"event_type":"dns"}' ']'
+ assert_json_valid '{"ts":"2026-01-28T00:01:00Z","id":2,"provider":"github","process":"git","pid":2222,"direction":"outbound","protocol":"https","remote_host":"github.com","remote_ip":"5.6.7.8","remote_port":443,"local_port":54322,"bytes_sent":1024,"bytes_received":2048,"is_known":true,"tags":["git"],"event_type":"dns"}' 'rano JSONL line should be valid JSON'
+ local 'json={"ts":"2026-01-28T00:01:00Z","id":2,"provider":"github","process":"git","pid":2222,"direction":"outbound","protocol":"https","remote_host":"github.com","remote_ip":"5.6.7.8","remote_port":443,"local_port":54322,"bytes_sent":1024,"bytes_received":2048,"is_known":true,"tags":["git"],"event_type":"dns"}'
+ local 'msg=rano JSONL line should be valid JSON'
+ TEST_ASSERTIONS=4
+ echo '{"ts":"2026-01-28T00:01:00Z","id":2,"provider":"github","process":"git","pid":2222,"direction":"outbound","protocol":"https","remote_host":"github.com","remote_ip":"5.6.7.8","remote_port":443,"local_port":54322,"bytes_sent":1024,"bytes_received":2048,"is_known":true,"tags":["git"],"event_type":"dns"}'
+ jq .
+ test_info 'PASS: rano JSONL line should be valid JSON'
+ test_log INFO 'PASS: rano JSONL line should be valid JSON'
+ local level=INFO
+ shift
++ date -Iseconds
+ echo '[2026-01-28T13:04:48-05:00] [INFO] PASS: rano JSONL line should be valid JSON'
[2026-01-28T13:04:48-05:00] [INFO] PASS: rano JSONL line should be valid JSON
+ IFS=
+ read -r line
+ run_vc_or_skip collect --collector rano
